---
description: Reglas para tests en Polybot — fixtures, mocks, httptest
globs: **/*_test.go
alwaysApply: false
---

# Testing — Convenciones Polybot

## Estructura
- Tests unitarios: mismo paquete (`package scanner`) para acceso a internals.
- Tests de integración de adapters: paquete `_test` (`package polymarket_test`).
- Fixtures JSON reales en `testdata/fixtures/`.

## Fixtures disponibles
```
testdata/fixtures/
  clob_sampling_markets.json   → respuesta real de /sampling-markets
  clob_orderbook.json          → respuesta real de /book (individual)
  clob_orderbooks_batch.json   → respuesta real de /books (batch)
```

## HTTP adapter tests con httptest
```go
func TestGetSamplingMarkets(t *testing.T) {
    data, _ := os.ReadFile("../../../testdata/fixtures/clob_sampling_markets.json")
    srv := httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        w.Header().Set("Content-Type", "application/json")
        w.Write(data)
    }))
    defer srv.Close()

    client := polymarket.NewClient(srv.URL, srv.URL)
    markets, err := client.FetchSamplingMarkets(context.Background())
    require.NoError(t, err)
    assert.NotEmpty(t, markets)
}
```

## Mocks de ports para scanner tests
```go
type mockMarketProvider struct {
    markets []domain.Market
    err     error
}
func (m *mockMarketProvider) FetchSamplingMarkets(ctx context.Context) ([]domain.Market, error) {
    return m.markets, m.err
}
```

## Assertions
- Usar `github.com/stretchr/testify/require` para fallos fatales.
- Usar `github.com/stretchr/testify/assert` para múltiples checks en un test.
- Nombres de test: `TestFuncName_Scenario_ExpectedBehavior`.

## Cobertura mínima esperada
- `domain/`: 90%+ (lógica pura, fácil de testear)
- `adapters/polymarket/`: 80%+ (con httptest)
- `scanner/`: 80%+ (con mocks)
