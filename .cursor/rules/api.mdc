---
description: Reglas para interactuar con la API de Polymarket (CLOB + Gamma)
globs: internal/adapters/polymarket/**
alwaysApply: false
---

# Polymarket API — Reglas

## Endpoints principales
| Endpoint | Base URL | Límite real | Límite seguro (60%) |
|----------|----------|-------------|----------------------|
| CLOB general | `https://clob.polymarket.com` | 9000 req/10s | 5400 req/10s |
| CLOB `/books` (batch) | mismo | 500 req/10s | 300 req/10s |
| CLOB `/midpoints` | mismo | 500 req/10s | 300 req/10s |
| Gamma `/markets` | `https://gamma-api.polymarket.com` | 300 req/10s | 180 req/10s |

## Endpoints críticos
- `GET /sampling-markets` → mercados con rewards activos (paginado, `limit=100`)
- `POST /books` → batch orderbooks por lista de `token_id`
- `GET /midpoints?token_id=A&token_id=B` → batch midpoints
- `GET /spreads?token_id=A&token_id=B` → batch spreads

## Rate limiter
```go
// Siempre usar golang.org/x/time/rate con token bucket al 60% del límite
limiter := rate.NewLimiter(rate.Every(10*time.Second/300), 10) // para /books
if err := limiter.Wait(ctx); err != nil {
    return fmt.Errorf("rate limit wait: %w", err)
}
```

## Retries con backoff
- Máx 3 intentos, backoff exponencial con jitter.
- HTTP 429 → backoff inmediato; leer `Retry-After` header si presente.
- HTTP 5xx → reintentar; HTTP 4xx (salvo 429) → no reintentar.

## Batch sizing
- `/books`: agrupar máximo 20 `token_id` por request.
- Un mercado binario tiene 2 tokens (YES/NO) → máx ~10 mercados por batch.

## DTOs vs Domain
- Los structs raw de la API van SOLO en `types.go`.
- La conversión API→domain va SOLO en `mapping.go`.
- Nunca uses DTOs fuera del paquete `polymarket`.
